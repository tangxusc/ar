# 构建流水线镜像流程

```shell
allrun pipeline build -p ./<pipeline_name>.template.json -t 流水线镜像名 -i ./镜像列表文件.txt(每行一个镜像名)
# 示例
allrun pipeline build -p ./alpine.template.json -t pipeline-alpine:latest -i ./images.txt
```

具体执行过程:
1. 校验<pipeline_name>.template.json文件是否存在
2. 校验 `镜像列表文件.txt`是否存在
3. 在tmp目录下创建临时目录,生成<流水线镜像名>_<时间戳>目录,并在命令执行完成后删除此目录,如果命令执行过程中出现错误,则删除此目录
4. 读取`镜像列表文件.txt`文件,每行一个镜像名,使用allrun image pull <镜像名>命令拉取镜像,并保存到<流水线镜像名>_<时间戳>/images-store/<镜像名>目录下
5. 将pipeline.template.json文件复制到<流水线镜像名>_<时间戳>目录下
6. 写入<流水线镜像名>_<时间戳>/Dockerfile文件,内容为:
```dockerfile
FROM alpine:latest

COPY entrypoint.sh /entrypoint.sh
COPY <pipeline_name>.template.json /<pipeline_name>.template.json
COPY ./images-store/* /images-store/

ENTRYPOINT ["/entrypoint.sh"]
```
7.写入entrypoint.sh文件,内容为:
```shell
#!/bin/sh
cp /*.json /pipelines/
cp ./images-store/* /images-store/
```
8. 参照 docker build 命令构建镜像：**必须基于 Dockerfile 中第一条 FROM 指令指定的基础镜像**进行构建（先解析 FROM，再从 --images-store-dir 或远程拉取该基础镜像，再在其上追加 entrypoint/模板/images-store 层）。Dockerfile 路径规则：未指定 -f 时使用构建目录下的 Dockerfile；指定 -f 时，若为绝对路径则直接使用，若为相对路径则优先按当前工作目录解析（外部文件），否则按构建目录解析。构建结果保存至 images-store-dir（该目录在 global flags 中配置）。

## 参照
```shell
`images-store-dir`(/var/lib/ar/images)目录下<流水线镜像名>目录结构如下:
root@VM-16-13-ubuntu:/var/lib/ar/images/alpine# tree .
.
├── blobs
│   └── sha256
│       ├── 0b3758261bedce8f0297853ee0dafd62732fe4a1b8ed6f5d6a57c8abdf5bc7e3
│       ├── 20dca686e485c6b4134dd71a62ce21505e189a285d33d37d41d9bfd87d190999
│       └── a40c03cbb81c59bfb0e0887ab0b1859727075da7b9cc576a1cec2c771f38c5fb
├── index.json
└── oci-layout
```
