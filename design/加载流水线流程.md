# 加载流水线流程

## 加载流水线

支持两种方式：

1. **从归档文件加载**（原有方式）  
   `-i` 指定流水线 OCI 镜像归档路径（.tar 或 .tar.gz）。

2. **从本地镜像存储加载**  
   `--from-store` 指定 `--images-store-dir` 中已存在的流水线镜像名（与 `-i` 二选一）。

```
# 从归档加载
ar load -i 流水线.tar.gz
# 示例
./allrun load -i /workspace/pipelines/pipeline-alpine.tar.gz

# 从本地 images-store-dir 加载（镜像须已存在，如曾 pipeline build 或 load -i 导入）
./allrun load --from-store pipeline-alpine_latest
```
**镜像导入与运行**：不再调用 podman API，改为直接依赖 OCI 规范实现。详见 **《OCI镜像导入与运行.md》**（使用 `containers/image` 导入镜像，libcontainer 运行容器）。

调用 oci image load api 加载镜像，并调用 oci runtime create api 运行一次性容器；
容器运行时,将宿主机`/var/lib/ar/pipelines/`目录挂载到容器`/pipelines/`目录下。
容器运行时,将宿主机`/tmp/镜像名/images/`目录挂载到容器`/images/`目录下。
流水线.tar.gz镜像内在运行时:
将镜像内的pipeline_name.template.json文件复制到容器`/pipelines/`目录下。
将镜像内的其他容器.tar.gz镜像复制到容器`/images/`目录下。
在流水线镜像执行完成后,调用oci image load api 加载 宿主机`/tmp/镜像名/images/`目录 下的所有镜像,加载完成后清理目录

如果镜像加载失败,则返回错误。
如果容器运行失败(非0退出码),则返回错误。