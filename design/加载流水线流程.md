# 加载流水线流程

## 加载流水线

```
ar load -i 流水线.tar.gz(oci规范的镜像)
# 示例
./allrun load -i /workspace/pipelines/pipeline-alpine.tar.gz
```
**镜像导入与运行**：不再调用 podman API，改为直接依赖 OCI 规范实现。详见 **《OCI镜像导入与运行.md》**（使用 `containers/image` 导入镜像，libcontainer 运行容器）。

调用 oci image load api 加载镜像，并调用 oci runtime create api 运行一次性容器；
容器运行时,将宿主机`/var/lib/ar/pipelines/`目录挂载到容器`/pipelines/`目录下。
容器运行时,将宿主机`/tmp/镜像名/images/`目录挂载到容器`/images/`目录下。
流水线.tar.gz镜像内在运行时:
将镜像内的pipeline_name.template.json文件复制到容器`/pipelines/`目录下。
将镜像内的其他容器.tar.gz镜像复制到容器`/images/`目录下。
在流水线镜像执行完成后,调用oci image load api 加载 宿主机`/tmp/镜像名/images/`目录 下的所有镜像,加载完成后清理目录

如果镜像加载失败,则返回错误。
如果容器运行失败(非0退出码),则返回错误。